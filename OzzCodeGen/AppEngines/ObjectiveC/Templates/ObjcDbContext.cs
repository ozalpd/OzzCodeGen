// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 12.0.0.0
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------
namespace OzzCodeGen.AppEngines.ObjectiveC.Templates
{
    using System.Linq;
    using System.Text;
    using System.Collections.Generic;
    using OzzUtils;
    using System;
    
    /// <summary>
    /// Class to produce the template output
    /// </summary>
    
    #line 1 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "12.0.0.0")]
    public partial class ObjcDbContext : BaseObjcClassImpl
    {
#line hidden
        /// <summary>
        /// Create the template output
        /// </summary>
        public override string TransformText()
        {
            
            #line 7 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
 WriteDeclataritons(); 
            
            #line default
            #line hidden
            this.Write("#import \"AppSettings.h\"\r\n\r\n//Do not modify this file! Generate it again!\r\n@interf" +
                    "ace ");
            
            #line 11 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(ObjectiveCName));
            
            #line default
            #line hidden
            this.Write("()\r\n@property (nonatomic, readonly) NSArray *scriptFiles;\r\n@property (nonatomic) " +
                    "NSString *servicerUrl;\r\n@end\r\n\r\n@implementation ");
            
            #line 16 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(ObjectiveCName));
            
            #line default
            #line hidden
            this.Write("\r\n- (void)dealloc\r\n{\r\n    self.delegate = nil;\r\n    sqlite3_close(self.dbHandler)" +
                    ";\r\n#if !__has_feature(objc_arc)\r\n");
            
            #line 22 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  foreach (var storageEntity in StorageEntitySettings)
	{ 
		string entityContext = storageEntity.Name.ToCamelCase().Pluralize();
		var entity = AppEngine.GetEntityByName(storageEntity.Name); 
            
            #line default
            #line hidden
            this.Write("    if(_");
            
            #line 26 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write("){\r\n        [_");
            
            #line 27 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(" release];\r\n    }\r\n");
            
            #line 29 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  } 
            
            #line default
            #line hidden
            this.Write("    if(_scriptFiles){\r\n        [_scriptFiles release];\r\n    }\r\n    [super dealloc" +
                    "];\r\n#endif\r\n}\r\n\r\n#pragma mark - Property Implementations\r\n- (NSString *)servicer" +
                    "Url\r\n{\r\n    if (_servicerUrl==nil) {\r\n");
            
            #line 41 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
 
	if (AppEngine.BaseEntityContext == "NSObject")	{ 
            
            #line default
            #line hidden
            this.Write("        _servicerUrl = @\"");
            
            #line 43 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ServerUrl));
            
            #line default
            #line hidden
            this.Write("\";\r\n");
            
            #line 44 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  }
	else { 
            
            #line default
            #line hidden
            this.Write("        _servicerUrl = [[AppSettings sharedSettings] servicerUrl];\r\n");
            
            #line 47 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  } 
            
            #line default
            #line hidden
            this.Write("    }\r\n    return _servicerUrl;\r\n}\r\n@synthesize servicerUrl = _servicerUrl;\r\n\r\n@s" +
                    "ynthesize isDataLoading = _isDataLoading;\r\n");
            
            #line 54 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  foreach (var storageEntity in StorageEntitySettings)
	{ 
		string entityContext = storageEntity.Name.ToCamelCase().Pluralize();
		var entity = AppEngine.GetEntityByName(storageEntity.Name); 
            
            #line default
            #line hidden
            this.Write("\r\n- (");
            
            #line 59 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(storageEntity.Name));
            
            #line default
            #line hidden
            this.Write("Context *)");
            
            #line 59 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write("\r\n{\r\n    if(_");
            
            #line 61 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(" == nil){\r\n");
            
            #line 62 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
 
	if (AppEngine.BaseEntityContext == "NSObject")
	{ 
            
            #line default
            #line hidden
            this.Write("        _");
            
            #line 65 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(" = [[");
            
            #line 65 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(storageEntity.Name));
            
            #line default
            #line hidden
            this.Write("Context alloc] initWithContext:self];\r\n");
            
            #line 66 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  } else { 
            
            #line default
            #line hidden
            this.Write("        _");
            
            #line 67 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(" = [[");
            
            #line 67 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(storageEntity.Name));
            
            #line default
            #line hidden
            this.Write("Context alloc] initWithContext:self andWithBaseUrl:self.servicerUrl];\r\n");
            
            #line 68 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  } 
            
            #line default
            #line hidden
            this.Write("        _");
            
            #line 69 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(".delegate = self;\r\n");
            
            #line 70 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
 
	if (entity != null && entity.AutoSaveToLocal)
	{ 
            
            #line default
            #line hidden
            this.Write("        _");
            
            #line 73 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(".autoSaveDownloaded = YES;\r\n");
            
            #line 74 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  } 
            
            #line default
            #line hidden
            this.Write("    }\r\n    return _");
            
            #line 76 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(";\r\n}\r\n");
            
            #line 78 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(storageEntity.Name));
            
            #line default
            #line hidden
            this.Write("Context *_");
            
            #line 78 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entityContext));
            
            #line default
            #line hidden
            this.Write(";\r\n");
            
            #line 79 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  } 
            
            #line default
            #line hidden
            this.Write("\r\n#pragma mark - EntityContextDelegate\r\n- (void)onGotEntity:(id)entity fromJsonDi" +
                    "ctionary:(NSDictionary *)dictionary typeOfEntity:(");
            
            #line 82 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 82 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(")entityType\r\n{\r\n    //Do not modify this method, modify it from custom base class" +
                    "\r\n}\r\n- (void)onGotEntityFromDb:(id)entity typeOfEntity:(");
            
            #line 86 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 86 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(")entityType\r\n{\r\n    //Do not modify this method, modify it from custom base class" +
                    "\r\n}\r\n- (void)onEntitySaved:(id)entity typeOfEntity:(");
            
            #line 90 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 90 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(")entityType\r\n{\r\n    //Do not modify this method, modify it from custom base class" +
                    "\r\n}\r\n- (void)onDeletingEntity:(id)entity typeOfEntity:(");
            
            #line 94 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 94 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(")entityType\r\n{\r\n    //Do not modify this method, modify it from custom base class" +
                    "\r\n}\r\n- (void)onEntityDeleted:(id)entity typeOfEntity:(");
            
            #line 98 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 98 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(@")entityType
{
    //Do not modify this method, modify it from custom base class
}
- (void)onDeletingTypeOfEntities:(KryEntityType)entityType
{
    //Do not modify this method, modify it from custom base class
}
- (void)onDeletedTypeOfEntities:(KryEntityType)entityType
{
    //Do not modify this method, modify it from custom base class
}
- (void)onFailToDeleteEntity:(id)entity sqliteResult:(int)result typeOfEntity:(");
            
            #line 110 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 110 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(")entityType\r\n{\r\n    if(entity)\r\n    {\r\n        if([entity isKindOfClass:[");
            
            #line 114 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            this.Write("AbstractEntity class]])\r\n        {\r\n            KryAbstractEntity *");
            
            #line 116 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix.ToLowerInvariant()));
            
            #line default
            #line hidden
            this.Write("Entity = (");
            
            #line 116 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            this.Write("AbstractEntity *)entity;\r\n            NSLog(@\"Delete Error: Entity with uniqueId " +
                    "%ld, type %lu \", (long)");
            
            #line 117 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix.ToLowerInvariant()));
            
            #line default
            #line hidden
            this.Write(@"Entity.uniqueId, (unsigned long)entityType);
        }
        else
        {
            NSLog(@""Delete Error: Entity  class of %@, type %lu"", [entity class], (unsigned long)entityType);
        }
    }
    else
    {
        NSLog(@""Delete Error: Entity is null. Entity Type %lu."", (unsigned long)entityType);
    }
}

#pragma mark - DataContextDelegate
- (void)onDataLoading
{
    _isDataLoading = YES;
    [self.delegate onDataLoading];
}
- (void)onArrayLoaded:(NSArray *)array typeOfEntity:(");
            
            #line 136 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 136 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(")entityType\r\n{\r\n    _isDataLoading = NO;\r\n    [self.delegate onArrayLoaded:array " +
                    "typeOfEntity:entityType];\r\n}\r\n- (void)onEntityLoaded:(id)entity typeOfEntity:(");
            
            #line 141 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.ClassPrefix));
            
            #line default
            #line hidden
            
            #line 141 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(AppEngine.Project.EntityTrackEnum));
            
            #line default
            #line hidden
            this.Write(@")entityType
{
    _isDataLoading = NO;
    [self.delegate onEntityLoaded:entity typeOfEntity:entityType];
}

- (void)onError:(NSString *)errorMsg
{
    _isDataLoading = NO;
    [self.delegate onError:errorMsg];
}
- (void)onParseError:(NSString *)errorMsg
{
    if([self.delegate respondsToSelector:@selector(didReceiveData:)]){
        [self.delegate onParseError:errorMsg];
    }
}

- (void)didReceiveResponse:(NSURLResponse *)response
{
    if([self.delegate respondsToSelector:@selector(didReceiveData:)]){
        [self.delegate didReceiveResponse:response];
    }
}
- (void)didReceiveData:(NSData *)data
{
    _isDataLoading = NO;
    if([self.delegate respondsToSelector:@selector(didReceiveData:)]){
        [self.delegate didReceiveData:data];
    }
}

#pragma mark - Private Methods
- (BOOL)createTables
{
    BOOL result = YES;
    for (NSString *file in self.scriptFiles) {
        result = ([self executeSqlFile:file] == SQLITE_OK) & result;
    }
    
    return result;
}

- (NSArray *)scriptFiles
{
    if(_scriptFiles == nil){
        _scriptFiles = @[
");
            
            #line 188 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  foreach (var entity in StorageEntitySettings)
	{ 
            
            #line default
            #line hidden
            this.Write("                         [[NSBundle mainBundle] pathForResource:@\"");
            
            #line 190 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(entity.Name));
            
            #line default
            #line hidden
            this.Write("\" ofType:@\"sql\"],\r\n");
            
            #line 191 "F:\OzzCodeGen\Source\OzzCodeGen\AppEngines\ObjectiveC\Templates\ObjcDbContext.tt"
  } 
            
            #line default
            #line hidden
            this.Write("                         ];\r\n    }\r\n    return _scriptFiles;\r\n}\r\nNSArray *_script" +
                    "Files;\r\n@end\r\n");
            return this.GenerationEnvironment.ToString();
        }
    }
    
    #line default
    #line hidden
}
